<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å®å¯æ¢¦è¯¦æƒ…æŸ¥è¯¢</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* å…³é”®ï¼šçˆ¶å®¹å™¨å®¹å™¨ä½¿ç”¨flexå¸ƒå±€å¹¶é™åˆ¶é«˜åº¦ */
        .chart-page {
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 60px); /* å‡å»é¡µé¢è¾¹è· */
        }

        .info-container {
            display: flex;
            gap: 20px;
            flex: 1; /* å æ»¡å‰©ä½™é«˜åº¦ */
            overflow: hidden; /* éšè—æº¢å‡ºå†…å®¹ */
        }

        /* å·¦ä¾§åˆ—è¡¨åŒºåŸŸ - é™åˆ¶é«˜åº¦+æ»šåŠ¨ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼‰ */
        .pokemon-list-section {
            width: 30%;
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: calc(100vh - 100px); /* å›ºå®šé«˜åº¦ï¼šè§†å£é«˜åº¦ - é¡¶éƒ¨è¾¹è· - é—´è· */
            max-height: 800px; /* æœ€å¤§é«˜åº¦é™åˆ¶ï¼Œé¿å…å¤§å±è¿‡é«˜ */
        }

        .search-box {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            width: 100%;
        }

        .pokemon-list {
            flex: 1; /* å æ»¡å‰©ä½™é«˜åº¦ */
            overflow-y: auto; /* è¶…å‡ºéƒ¨åˆ†æ»šåŠ¨ */
            overflow-x: hidden; /* ç¦æ­¢æ°´å¹³æ»šåŠ¨ */
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 10px;
            /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ï¼ˆä¼˜åŒ–è§†è§‰ï¼‰ */
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ï¼ˆChrome/Safariï¼‰ */
        .pokemon-list::-webkit-scrollbar {
            width: 6px; /* æ»šåŠ¨æ¡å®½åº¦ */
        }
        .pokemon-list::-webkit-scrollbar-thumb {
            background-color: #3498db; /* æ»šåŠ¨æ¡æ»‘å—é¢œè‰²ï¼ˆè´´åˆé¡¹ç›®è“ï¼‰ */
            border-radius: 3px; /* æ»‘å—åœ†è§’ */
        }
        .pokemon-list::-webkit-scrollbar-track {
            background-color: #f5f5f5; /* æ»šåŠ¨æ¡è½¨é“é¢œè‰² */
        }

        .pokemon-item {
            padding: 10px;
            margin-bottom: 8px;
            background-color: #f9f9f9;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .pokemon-item:hover {
            background-color: #e8f4fd;
        }

        .pokemon-item.active {
            background-color: #d1e7fd;
            border-left: 3px solid #3498db;
        }

        /* å³ä¾§è¯¦æƒ…åŒºåŸŸ - ä¸å·¦ä¾§ç­‰é«˜ */
        .pokemon-detail-section {
            width: 70%;
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: calc(100vh - 100px); /* ä¸å·¦ä¾§ä¿æŒç­‰é«˜ */
            max-height: 800px; /* æœ€å¤§é«˜åº¦é™åˆ¶ */
            overflow-y: auto; /* å†…éƒ¨æ»šåŠ¨ */
            padding-bottom: 20px; /* é¿å…åº•éƒ¨å†…å®¹è¢«æˆªæ–­ */
        }

        .detail-card {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .detail-title {
            font-size: 24px;
            color: #2c3e50;
        }

        .type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            margin-left: 10px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 16px;
            font-weight: 500;
        }

        .radar-container {
            height: 400px;
            width: 100%;
        }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #999;
            text-align: center;
            padding: 40px;
            height: 100%; /* å æ»¡å³ä¾§é«˜åº¦ */
        }

        .empty-state i {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .error-message {
            color: #e74c3c;
            padding: 10px;
            text-align: center;
        }

        /* AIä»‹ç»åŒºåŸŸæ ·å¼ */
        .ai-intro-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f7ff;
            border-radius: 6px;
            border-left: 3px solid #3498db;
        }

        .ai-intro-loading {
            color: #666;
            text-align: center;
            padding: 20px;
        }

        .typing-indicator {
            display: inline-flex;
            gap: 4px;
            margin-left: 5px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background-color: #666;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
        }

        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .ai-intro-error {
            color: #e74c3c;
            text-align: center;
            padding: 20px;
        }

        /* å“åº”å¼é€‚é…ï¼šå°å±å¹•è°ƒæ•´å¸ƒå±€ */
        @media (max-width: 768px) {
            .info-container {
                flex-direction: column;
            }
            .pokemon-list-section, .pokemon-detail-section {
                width: 100%;
                height: auto; /* å°å±å¹•å–æ¶ˆå›ºå®šé«˜åº¦ */
                max-height: none;
            }
            .pokemon-list-section {
                max-height: 300px; /* å°å±å¹•åˆ—è¡¨æœ€å¤§é«˜åº¦ */
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="chart-page">
        <div class="chart-header">
            <h2 class="chart-title">å®å¯æ¢¦è¯¦æƒ…æŸ¥è¯¢</h2>
            <a href="../index.html" class="back-btn">è¿”å›ä¸»é¡µé¢</a>
        </div>

        <div class="info-container">
            <!-- å·¦ä¾§ï¼šç²¾çµåˆ—è¡¨ + æœç´¢ -->
            <div class="pokemon-list-section">
                <input type="text" class="search-box" placeholder="æœç´¢å®å¯æ¢¦åç§°..." id="searchInput">
                <div class="pokemon-list" id="pokemonList"></div>
            </div>

            <!-- å³ä¾§ï¼šè¯¦æƒ… + é›·è¾¾å›¾ -->
            <div class="pokemon-detail-section" id="detailSection">
                <div class="empty-state">
                    <i>ğŸ”</i>
                    <h3>è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€åªå®å¯æ¢¦</h3>
                    <p>æŸ¥çœ‹å®ƒçš„è¯¦ç»†ä¿¡æ¯å’Œèƒ½åŠ›å¯¹æ¯”</p>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/data.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        // é…ç½®DeepSeek APIå¯†é’¥ï¼ˆå‰ç«¯ä»£ç ä»æœ‰æ³„éœ²é£é™©ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®é€šè¿‡åç«¯ä»£ç†ï¼‰
        const DEEPSEEK_API_KEY = 'sk-bb6c198c5f734d02b3dd432c6b956c54';
        const DEEPSEEK_API_URL = 'https://api.deepseek.com/v1/chat/completions';

        let allPokemon = [];
        let filteredPokemon = [];  // æ–°å¢ï¼šå­˜å‚¨å½“å‰ç­›é€‰åçš„å®å¯æ¢¦åˆ—è¡¨
        let avgAbilities = null;
        let radarChart = null;
        let currentAbortController = null; // ç”¨äºå–æ¶ˆå½“å‰çš„APIè¯·æ±‚

        window.addEventListener('dataLoaded', () => {
            allPokemon = window.pokemonData || [];
            filteredPokemon = [...allPokemon];  // åˆå§‹åŒ–ç­›é€‰åˆ—è¡¨ä¸ºå…¨éƒ¨æ•°æ®
            console.log('åŠ è½½åˆ°çš„å®å¯æ¢¦æ•°é‡:', allPokemon.length);
            
            if (allPokemon.length === 0) {
                document.getElementById('pokemonList').innerHTML = 
                    '<div class="error-message">æ²¡æœ‰åŠ è½½åˆ°å®å¯æ¢¦æ•°æ®</div>';
                return;
            }

            calculateAvgAbilities();
            renderPokemonList(filteredPokemon);
            initEventListeners();
        });

        function calculateAvgAbilities() {
            const abilities = window.abilities;
            const totals = abilities.reduce((acc, ab) => ({ ...acc, [ab]: 0 }), {});
            let count = 0;

            allPokemon.forEach(p => {
                count++;
                abilities.forEach(ab => {
                    totals[ab] += Number(p[ab]) || 0;
                });
            });

            avgAbilities = abilities.map(ab => (totals[ab] / count).toFixed(1));
        }

        function renderPokemonList(pokemonData) {
            const listContainer = document.getElementById('pokemonList');
            listContainer.innerHTML = '';

            if (pokemonData.length === 0) {
                listContainer.innerHTML = '<div class="empty-state">æ— åŒ¹é…çš„å®å¯æ¢¦</div>';
                return;
            }

            pokemonData.forEach((p, index) => {
                const uniqueId = index;  // ç´¢å¼•åŸºäºå½“å‰ç­›é€‰åçš„åˆ—è¡¨
                const item = document.createElement('div');
                item.className = 'pokemon-item';
                item.dataset.uniqueId = uniqueId;
                item.innerHTML = `
                    <div><strong>${p.Name || 'æœªçŸ¥åç§°'}</strong></div>
                    <div>
                        <span class="type-badge" style="background-color: ${window.getTypeColor(p["Type 1"])}">
                            ${p["Type 1"] || 'æœªçŸ¥'}
                        </span>
                        ${p["Type 2"] ? `<span class="type-badge" style="background-color: ${window.getTypeColor(p["Type 2"])}">
                            ${p["Type 2"]}
                        </span>` : ''}
                    </div>
                `;
                listContainer.appendChild(item);
            });
        }

        function showPokemonDetail(index) {
            // å¦‚æœæœ‰æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚ï¼Œå–æ¶ˆå®ƒ
            if (currentAbortController) {
                currentAbortController.abort();
                currentAbortController = null;
            }

            // ä½¿ç”¨ç­›é€‰åçš„åˆ—è¡¨è·å–æ•°æ®ï¼Œè€Œä¸æ˜¯åŸå§‹çš„allPokemon
            if (index < 0 || index >= filteredPokemon.length) {
                console.error('æ— æ•ˆçš„å®å¯æ¢¦ç´¢å¼•:', index);
                return;
            }

            const pokemon = filteredPokemon[index];
            if (!pokemon) {
                console.error('æœªæ‰¾åˆ°å®å¯æ¢¦æ•°æ®');
                return;
            }

            const detailSection = document.getElementById('detailSection');
            const abilities = window.abilities;

            // æ¸²æŸ“è¯¦æƒ…é¡µé¢ï¼ŒåŒ…å«AIä»‹ç»åŒºåŸŸï¼ˆåˆå§‹æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼‰
            detailSection.innerHTML = `
                <div class="detail-card">
                    <div class="detail-header">
                        <div>
                            <h3 class="detail-title">${pokemon.Name || 'æœªçŸ¥åç§°'}</h3>
                            <div>
                                <span class="type-badge" style="background-color: ${window.getTypeColor(pokemon["Type 1"])}">
                                    ${pokemon["Type 1"] || 'æœªçŸ¥'}
                                </span>
                                ${pokemon["Type 2"] ? `<span class="type-badge" style="background-color: ${window.getTypeColor(pokemon["Type 2"])}">
                                    ${pokemon["Type 2"]}
                                </span>` : ''}
                            </div>
                        </div>
                        <div>
                            <div class="detail-item">
                                <span class="detail-label">ä¸–ä»£</span>
                                <span class="detail-value">ç¬¬${pokemon.Generation || '??'}ä¸–ä»£</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">æ˜¯å¦ä¼ å¥‡</span>
                                <span class="detail-value">${pokemon.Legendary == "True" ? 'æ˜¯' : 'å¦'}</span>
                            </div>
                        </div>
                    </div>

                    <div class="detail-grid">
                        ${abilities.map(ab => `
                            <div class="detail-item">
                                <span class="detail-label">${ab}</span>
                                <span class="detail-value">${pokemon[ab] || 0}</span>
                            </div>
                        `).join('')}
                        <div class="detail-item">
                            <span class="detail-label">æ€»èƒ½åŠ›å€¼</span>
                            <span class="detail-value">${pokemon.Total || 0}</span>
                        </div>
                    </div>

                    <!-- AIä»‹ç»åŒºåŸŸ -->
                    <div class="ai-intro-section" id="aiIntroSection">
                        <h4 style="margin-top: 0; color: #2c3e50;">å®å¯æ¢¦ä»‹ç»</h4>
                        <div class="ai-intro-loading">
                            <p>æ­£åœ¨ç”Ÿæˆ<span class="typing-indicator">
                                <span></span><span></span><span></span>
                            </span></p>
                        </div>
                    </div>
                </div>

                <div class="detail-card">
                    <h3 class="detail-title">èƒ½åŠ›å€¼å¯¹æ¯”ï¼ˆä¸æ‰€æœ‰å®å¯æ¢¦å¹³å‡ï¼‰</h3>
                    <div class="radar-container" id="comparisonRadar"></div>
                </div>
            `;

            document.querySelectorAll('.pokemon-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.pokemon-item[data-unique-id="${index}"]`).classList.add('active');

            renderRadarChart(pokemon);
            // è°ƒç”¨APIè·å–AIä»‹ç»ï¼ˆæµå¼ï¼‰
            fetchPokemonIntroStream(pokemon.Name);
        }

        // è°ƒç”¨DeepSeek APIè·å–å®å¯æ¢¦ä»‹ç»ï¼ˆæµå¼è¾“å‡ºï¼‰
        async function fetchPokemonIntroStream(pokemonName) {
            const introSection = document.getElementById('aiIntroSection');
            const contentElement = document.createElement('p');
            contentElement.style.marginBottom = '0';
            
            // æ›¿æ¢åŠ è½½æŒ‡ç¤ºå™¨ä¸ºå†…å®¹å®¹å™¨
            introSection.innerHTML = `
                <h4 style="margin-top: 0; color: #2c3e50;">å®å¯æ¢¦ä»‹ç»</h4>
            `;
            introSection.appendChild(contentElement);

            // åˆ›å»ºæ–°çš„AbortController
            currentAbortController = new AbortController();
            
            try {
                const response = await fetch(DEEPSEEK_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            {
                                role: "user",
                                content: `è¯·ç›´æ¥ç»™å‡ºä¸€æ®µè¯ä»‹ç»å®å¯æ¢¦ä¸­çš„${pokemonName}ï¼Œä¸éœ€è¦å‰å¯¼`
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 200,
                        stream: true  // å¯ç”¨æµå¼å“åº”
                    }),
                    signal: currentAbortController.signal  // å…³è”abortä¿¡å·
                });

                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }

                // è·å–å“åº”æµçš„é˜…è¯»å™¨
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullContent = '';

                // å¾ªç¯è¯»å–æµæ•°æ®
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    // è§£ç æ¥æ”¶åˆ°çš„äºŒè¿›åˆ¶æ•°æ®
                    const chunk = decoder.decode(value, { stream: true });
                    
                    // å¤„ç†æ¯ä¸ªSSEäº‹ä»¶
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (trimmedLine === '') continue;
                        if (trimmedLine === 'data: [DONE]') break;
                        
                        if (trimmedLine.startsWith('data: ')) {
                            try {
                                const jsonStr = trimmedLine.slice(6); // ç§»é™¤'data: 'å‰ç¼€
                                const data = JSON.parse(jsonStr);
                                
                                // æå–å†…å®¹ç‰‡æ®µå¹¶ç´¯åŠ 
                                const content = data.choices?.[0]?.delta?.content || '';
                                if (content) {
                                    fullContent += content;
                                    // æ›´æ–°DOMæ˜¾ç¤º
                                    contentElement.textContent = fullContent;
                                }
                            } catch (e) {
                                console.error('è§£ææµå¼æ•°æ®å¤±è´¥:', e);
                            }
                        }
                    }
                }

            } catch (error) {
                // å¿½ç•¥ä¸­æ­¢é”™è¯¯ï¼ˆç”¨æˆ·ä¸»åŠ¨åˆ‡æ¢å®å¯æ¢¦æ—¶ä¼šè§¦å‘ï¼‰
                if (error.name !== 'AbortError') {
                    console.error('è·å–å®å¯æ¢¦ä»‹ç»å¤±è´¥:', error);
                    introSection.innerHTML = `
                        <h4 style="margin-top: 0; color: #2c3e50;">å®å¯æ¢¦ä»‹ç»</h4>
                        <div class="ai-intro-error">
                            <p>è·å–ä»‹ç»å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>
                            <p style="font-size: 12px;">(${error.message})</p>
                        </div>
                    `;
                }
            } finally {
                // æ¸…é™¤å½“å‰è¯·æ±‚æ§åˆ¶å™¨
                if (currentAbortController?.signal.aborted === false) {
                    currentAbortController = null;
                }
            }
        }

        function renderRadarChart(pokemon) {
            const container = document.getElementById('comparisonRadar');
            if (!container) return;

            if (radarChart) {
                radarChart.dispose();
            }
            radarChart = echarts.init(container);

            const abilities = window.abilities;
            const pokemonAbilities = abilities.map(ab => Number(pokemon[ab]) || 0);

            radarChart.setOption({
                tooltip: { trigger: 'item' },
                legend: {
                    data: ['å½“å‰å®å¯æ¢¦', 'æ‰€æœ‰å®å¯æ¢¦å¹³å‡'],
                    top: 0
                },
                radar: {
                    indicator: abilities.map(ab => ({
                        name: ab,
                        max: Math.max(...pokemonAbilities, ...avgAbilities.map(Number)) + 50
                    }))
                },
                series: [
                    {
                        name: 'èƒ½åŠ›å¯¹æ¯”',
                        type: 'radar',
                        data: [
                            {
                                name: 'å½“å‰å®å¯æ¢¦',
                                value: pokemonAbilities,
                                itemStyle: { color: '#3498db' },
                                lineStyle: { color: '#3498db' },
                                areaStyle: { color: 'rgba(52, 152, 219, 0.2)' }
                            },
                            {
                                name: 'æ‰€æœ‰å®å¯æ¢¦å¹³å‡',
                                value: avgAbilities,
                                itemStyle: { color: '#e74c3c' },
                                lineStyle: { color: '#e74c3c' },
                                areaStyle: { color: 'rgba(231, 76, 60, 0.2)' }
                            }
                        ]
                    }
                ]
            });

            window.addEventListener('resize', () => radarChart.resize());
        }

        function initEventListeners() {
            document.getElementById('searchInput').addEventListener('input', (e) => {
                const keyword = e.target.value.trim().toLowerCase();
                filteredPokemon = allPokemon.filter(p => 
                    (p.Name || '').toLowerCase().includes(keyword)
                );
                renderPokemonList(filteredPokemon);  // æ¸²æŸ“ç­›é€‰åçš„åˆ—è¡¨
            });

            document.getElementById('pokemonList').addEventListener('click', (e) => {
                const item = e.target.closest('.pokemon-item');
                if (item) {
                    const uniqueId = parseInt(item.dataset.uniqueId, 10);
                    if (!isNaN(uniqueId)) {
                        showPokemonDetail(uniqueId);  // ä½¿ç”¨ç­›é€‰åˆ—è¡¨çš„ç´¢å¼•
                    } else {
                        console.error('æ— æ³•è·å–å®å¯æ¢¦ID');
                    }
                }
            });
        }
    </script>
</body>
</html>